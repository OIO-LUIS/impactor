#!/usr/bin/env ruby

# Build script for asset compilation in development mode
# This script is useful for testing your build process locally

puts "🔧 Building assets for development..."

# Check if d3 is already pinned
importmap_content = File.read("config/importmap.rb")
unless importmap_content.include?('pin "d3"')
  puts "📦 Pinning d3 library..."
  system("bin/importmap pin d3") or raise "Failed to pin d3"
else
  puts "✅ d3 already pinned in importmap"
end

# Update stimulus manifest
puts "⚡ Updating stimulus manifest..."
result = system("bin/rails stimulus:manifest:update")
if result
  puts "✅ Stimulus manifest updated"
else
  puts "⚠️  Stimulus manifest update failed (this may be normal if no stimulus controllers exist)"
end

# Clean and precompile assets for development
puts "🧹 Cleaning existing assets..."
system("RAILS_ENV=development bin/rails assets:clobber") or raise "Failed to clean assets"

puts "🏗️  Precompiling assets for development..."
ENV["RAILS_ENV"] = "development"
ENV["SECRET_KEY_BASE"] = "dummy-secret-key-base-for-asset-precompilation-only-not-for-production-use"
ENV["DATABASE_URL"] = "postgresql://dummy:dummy@localhost:5432/dummy" if ENV["RAILS_ENV"] == "production"
ENV["DISABLE_DATABASE_ENVIRONMENT_CHECK"] = "1"
system("bin/rails assets:precompile") or raise "Failed to precompile assets"

puts "✅ Development asset build completed successfully!"