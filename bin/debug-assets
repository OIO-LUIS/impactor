#!/usr/bin/env ruby

# Asset debugging script for production issues
puts "ğŸ” Debugging asset configuration..."

# Check importmap configuration
puts "\nğŸ“‹ Checking importmap configuration:"
importmap_content = File.read("config/importmap.rb")
if importmap_content.include?('pin_all_from "app/javascript/controllers"')
  puts "âœ… Controllers are pinned via pin_all_from"
else
  puts "âŒ Controllers pin_all_from not found"
end

# Check if assets are precompiled
puts "\nğŸ“ Checking compiled assets:"
if Dir.exist?("public/assets")
  manifest_files = Dir.glob("public/assets/.sprockets-manifest-*.json")
  if manifest_files.any?
    puts "âœ… Asset manifest found: #{manifest_files.first}"
    
    # Check for controller assets
    controller_files = Dir.glob("public/assets/controllers/*.js").reject { |f| f.include?('.gz') }
    puts "âœ… Found #{controller_files.size} controller assets:"
    controller_files.first(5).each { |f| puts "  - #{File.basename(f)}" }
    puts "  ... and #{controller_files.size - 5} more" if controller_files.size > 5
    
  else
    puts "âŒ No asset manifest found"
  end
else
  puts "âŒ public/assets directory not found"
end

# Check production configuration
puts "\nâš™ï¸  Checking production configuration:"
production_config = File.read("config/environments/production.rb")

if production_config.include?("config.public_file_server.enabled = true")
  puts "âœ… Static file serving enabled"
else
  puts "âŒ Static file serving not explicitly enabled"
end

if production_config.include?("config.assets.compile = false")
  puts "âœ… Asset compilation disabled (correct for production)"
else
  puts "âš ï¸  Asset compilation setting unclear"
end

if production_config.include?("config.assets.digest = true")
  puts "âœ… Asset digests enabled"
else
  puts "âš ï¸  Asset digest setting not explicit"
end

# Check for stimulus controllers
puts "\nğŸ® Checking stimulus controllers:"
controller_dir = "app/javascript/controllers"
if Dir.exist?(controller_dir)
  controllers = Dir.glob("#{controller_dir}/*_controller.js")
  puts "âœ… Found #{controllers.size} stimulus controllers:"
  controllers.each { |f| puts "  - #{File.basename(f)}" }
else
  puts "âŒ Controllers directory not found"
end

puts "\nğŸ”§ Recommendations:"
puts "1. Run a full asset rebuild with: RAILS_ENV=production ./bin/build-assets"
puts "2. Check that your deployment sets RAILS_SERVE_STATIC_FILES=true"
puts "3. Commit changes and redeploy to apply production configuration fixes"
puts "4. Monitor Cloud Run logs for asset 404 errors"

puts "\nâœ… Asset debugging completed!"